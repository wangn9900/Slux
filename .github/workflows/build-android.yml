name: Build Android

on:
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26c
          add-to-path: true
      

      
      - name: Initialize Go module
        working-directory: core/mobile
        run: |
          rm -f go.mod go.sum
          go mod init libcore
          # 强制锁定 x/mobile 版本 (Nov 2023)，防止被上游依赖自动升级
          go mod edit -replace golang.org/x/mobile=golang.org/x/mobile@v0.0.0-20231108233038-35478a0c49da
          go get golang.org/x/mobile@35478a0c49da
          # 锁定 x/tools 到 v0.36.0 (NekoBox 标准)
          go get golang.org/x/tools@v0.36.0
          go get github.com/sagernet/sing-box@v1.12.15
          go mod tidy
          go mod vendor
      
      - name: Setup Gomobile
        run: |
          # 使用 NekoBox 维护的 gomobile fork
          git clone -b master2 https://github.com/MatsuriDayo/gomobile
          cd gomobile
          go install ./cmd/gomobile
          go install ./cmd/gobind
          # 配置环境变量并初始化
          GOBIND=$(go env GOPATH)/bin/gobind
          echo "GOBIND=$GOBIND" >> $GITHUB_ENV
          $GOBIND version
          gomobile init

      - name: Build libbox.aar
        working-directory: core/mobile
        run: |
          # 使用 vendor 模式构建
          mkdir -p ../../android/app/libs
          # 必须加上 -mod=vendor
          gomobile bind -v -androidapi 21 -target=android \
            -ldflags='-s -w' \
            -tags='with_conntrack,with_gvisor,with_quic,with_wireguard,with_utls,with_clash_api' \
            -o ../../android/app/libs/libbox.aar \
            . github.com/sagernet/sing-box/experimental/libbox
          ls -l ../../android/app/libs/
          gomobile bind -v -androidapi 21 -target=android -o ../../android/app/libs/libbox.aar . github.com/sagernet/sing-box/experimental/libbox
          ls -l ../../android/app/libs/
      
      - name: Copy to jniLibs
        run: |
          mkdir -p android/app/src/main/jniLibs/arm64-v8a
          mkdir -p android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p android/app/src/main/jniLibs/x86_64
          cp core/mobile/libbox.so android/app/src/main/jniLibs/arm64-v8a/
          cp core/mobile/libbox-armeabi-v7a.so android/app/src/main/jniLibs/armeabi-v7a/libbox.so
          cp core/mobile/libbox-x86_64.so android/app/src/main/jniLibs/x86_64/libbox.so
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Generate app icons
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
          
          # Generate Android icons
          ANDROID_PATH="android/app/src/main/res"
          mkdir -p "$ANDROID_PATH/mipmap-mdpi"
          mkdir -p "$ANDROID_PATH/mipmap-hdpi"
          mkdir -p "$ANDROID_PATH/mipmap-xhdpi"
          mkdir -p "$ANDROID_PATH/mipmap-xxhdpi"
          mkdir -p "$ANDROID_PATH/mipmap-xxxhdpi"
          
          # Use the pre-generated asset icon
          SOURCE_ICON="assets/app_icon.png"
          
          convert "$SOURCE_ICON" -resize 48x48 "$ANDROID_PATH/mipmap-mdpi/ic_launcher.png"
          convert "$SOURCE_ICON" -resize 72x72 "$ANDROID_PATH/mipmap-hdpi/ic_launcher.png"
          convert "$SOURCE_ICON" -resize 96x96 "$ANDROID_PATH/mipmap-xhdpi/ic_launcher.png"
          convert "$SOURCE_ICON" -resize 144x144 "$ANDROID_PATH/mipmap-xxhdpi/ic_launcher.png"
          convert "$SOURCE_ICON" -resize 192x192 "$ANDROID_PATH/mipmap-xxxhdpi/ic_launcher.png"
      
      - name: Build Android APK
        run: |
          flutter clean
          flutter build apk --release
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: slux-android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
      
      - name: Upload libbox.so artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libbox-libraries
          path: |
            android/app/src/main/jniLibs/arm64-v8a/libbox.so
            android/app/src/main/jniLibs/armeabi-v7a/libbox.so
            android/app/src/main/jniLibs/x86_64/libbox.so
