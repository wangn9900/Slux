name: Build Windows

on:
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Generate app icon
        run: |
          # Install ImageMagick
          choco install imagemagick -y
          
          # Create purple lightning icon using ImageMagick
          magick -size 1024x1024 xc:none -fill "#7C3AED" -draw "roundrectangle 0,0 1024,1024 100,100" `
            -fill white -font Arial-Bold -pointsize 800 -gravity center -annotate +0+0 "âš¡" `
            temp_icon.png
          
          # Convert to ICO with multiple sizes
          magick convert temp_icon.png -define icon:auto-resize=256,128,96,64,48,32,16 windows/runner/resources/app_icon.ico
          
          # Copy to root for tray icon
          Copy-Item windows/runner/resources/app_icon.ico app_icon.ico
          
          # Clean up
          Remove-Item temp_icon.png
        shell: powershell
      
      - name: Download Sing-box core
        run: |
          ./scripts/download_core.ps1
        shell: powershell
      
      - name: Build Windows Release
        run: |
          flutter clean
          flutter build windows --release
      
      - name: Package Windows App
        run: |
          # Copy tray icon to release directory
          Copy-Item -Path "windows/runner/resources/app_icon.ico" -Destination "build/windows/x64/runner/Release/app_icon.ico"

          # Copy sing-box core to release directory
          Copy-Item -Path "assets/core" -Destination "build/windows/x64/runner/Release" -Recurse
          
          # Create zip package
          Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath slux-windows-x64.zip
          
          # Create Installer using Inno Setup
          choco install innosetup -y
          
          # Run Inno Setup Compiler
          # Note: Inno Setup adds itself to PATH, but we might need to refresh env or use full path
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" scripts\windows_installer.iss
        shell: powershell
      
      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: slux-windows-x64
          path: |
            slux-windows-x64.zip
            build/windows/x64/slux_setup.exe
